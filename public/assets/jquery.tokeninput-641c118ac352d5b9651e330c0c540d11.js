/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.4.2
 *
 * -- MODIFIED to allow adding new tags --
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
(function(a){var b={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null},c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},d={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};a.fn.tokenInput=function(c,d){var e=a.extend({},b,d||{});return this.each(function(){new a.TokenList(this,c,e)})},a.TokenList=function(b,f,g){function u(){if(l===(l=m.val()))return;var a=l.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");t.html(a),m.width(t.width()+30)}function v(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function w(b,c){var d=a("<li><p>"+c+"</p> </li>").addClass(g.classes.token).insertBefore(r);a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(d).click(function(){return B(a(this).parent()),!1});var e={id:b,name:c};a.data(d.get(0),"tokeninput",e),h.push(e);var f=a.map(h,function(a){return a.name});return n.val(f.join(g.tokenDelimiter)),i+=1,d}function x(b){var c=a.data(b.get(0),"tokeninput"),d=g.onAdd;if(i>0&&g.preventDuplicates){var e=null;q.children().each(function(){var b=a(this),d=a.data(b.get(0),"tokeninput");if(d&&d.id===c.id)return e=b,!1});if(e){y(e),r.insertAfter(e),m.focus();return}}w(c.id,c.name);if(g.tokenLimit!==null&&i>=g.tokenLimit){m.hide(),C();return}m.focus(),m.val(""),C(),a.isFunction(d)&&d(c)}function y(a){a.addClass(g.classes.selectedToken),o=a.get(0),m.val(""),C()}function z(a,b){a.removeClass(g.classes.selectedToken),o=null,b===d.BEFORE?r.insertBefore(a):b===d.AFTER?r.insertAfter(a):r.appendTo(q),m.focus()}function A(b){var c=o;o&&z(a(o),d.END),c===b.get(0)?z(b,d.END):y(b)}function B(b){var c=a.data(b.get(0),"tokeninput"),d=g.onDelete;b.remove(),o=null,m.focus(),h=a.grep(h,function(a){return a.id!==c.id});var e=a.map(h,function(a){return a.name});n.val(e.join(g.tokenDelimiter)),i-=1,g.tokenLimit!==null&&m.show().val("").focus(),a.isFunction(d)&&d(c)}function C(){s.hide().empty(),p=null}function D(){s.css({position:"absolute",top:a(q).offset().top+a(q).outerHeight(),left:a(q).offset().left,zindex:999}).show()}function E(){g.searchingText&&(s.html("<p>"+g.searchingText+"</p>"),D())}function F(){g.hintText&&(s.html("<p>"+g.hintText+"</p>"),D())}function G(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function H(b,c){if(c&&c.length){s.empty();var d=a("<ul>").appendTo(s).mouseover(function(b){I(a(b.target).closest("li"))}).mousedown(function(b){return x(a(b.target).closest("li")),!1}).hide();a.each(c,function(c,e){var f=a("<li>"+G(e.name,b)+"</li>").appendTo(d);c%2?f.addClass(g.classes.dropdownItem):f.addClass(g.classes.dropdownItem2),c===0&&I(f),a.data(f.get(0),"tokeninput",{id:e.id,name:e.name})}),D(),g.animateDropdown?d.slideDown("fast"):d.show()}else g.noResultsText&&(s.html("<p>"+g.noResultsText+"</p>"),D())}function I(b){b&&(p&&J(a(p)),b.addClass(g.classes.selectedDropdownItem),p=b.get(0))}function J(a){a.removeClass(g.classes.selectedDropdownItem),p=null}function K(){var b=m.val().toLowerCase();b&&b.length&&(o&&z(a(o),d.AFTER),b.length>=g.minChars?(E(),clearTimeout(k),k=setTimeout(function(){L(b)},g.searchDelay)):C())}function L(b){var c=j.get(b);if(c)H(b,c);else if(g.url){var d={};d.data={};if(g.url.indexOf("?")>-1){var e=g.url.split("?");d.url=e[0];var f=e[1].split("&");a.each(f,function(a,b){var c=b.split("=");d.data[c[0]]=c[1]})}else d.url=g.url;d.data[g.queryParam]=b,d.type=g.method,d.dataType=g.contentType,g.crossDomain&&(d.dataType="jsonp"),d.success=function(c){a.isFunction(g.onResult)&&(c=g.onResult.call(this,c)),j.add(b,g.jsonContainer?c[g.jsonContainer]:c),m.val().toLowerCase()===b&&H(b,g.jsonContainer?c[g.jsonContainer]:c)},a.ajax(d)}else if(g.local_data){var h=a.grep(g.local_data,function(a){return a.name.toLowerCase().indexOf(b.toLowerCase())>-1});H(b,h)}}a.type(f)==="string"?(g.url=f,g.crossDomain===undefined&&(g.url.indexOf("://")===-1?g.crossDomain=!1:g.crossDomain=location.href.split(/\/+/g)[1]!==g.url.split(/\/+/g)[1])):a.type(f)==="array"&&(g.local_data=f),g.classes?g.classes=a.extend({},c,g.classes):g.theme?(g.classes={},a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})):g.classes=c;var h=[],i=0,j=new a.TokenList.Cache,k,l,m=a('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){(g.tokenLimit===null||g.tokenLimit!==i)&&F()}).blur(function(){C()}).bind("keyup keydown blur update",u).keydown(function(b){var c,f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!a(this).val())c=r.prev(),f=r.next(),c.length&&c.get(0)===o||f.length&&f.get(0)===o?b.keyCode===e.LEFT||b.keyCode===e.UP?z(a(o),d.BEFORE):z(a(o),d.AFTER):b.keyCode!==e.LEFT&&b.keyCode!==e.UP||!c.length?(b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length&&y(a(f.get(0))):y(a(c.get(0)));else{var g=null;return b.keyCode===e.DOWN||b.keyCode===e.RIGHT?g=a(p).next():g=a(p).prev(),g.length&&I(g),!1}break;case e.BACKSPACE:c=r.prev();if(!a(this).val().length)return o?B(a(o)):c.length&&y(a(c.get(0))),!1;a(this).val().length===1?C():setTimeout(function(){K()},5);break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:return p?(x(a(p)),!1):(value={name:a(".token-input-input-token-facebook > tester").text().replace(",",""),id:9999},w(value.id,value.name),a(".token-input-input-token-facebook > input").val(""),!1);case e.ESCAPE:return C(),!0;default:String.fromCharCode(b.which)&&setTimeout(function(){K()},5)}}),n=a(b).hide().val("").focus(function(){m.focus()}).blur(function(){m.blur()}),o=null,p=null,q=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");c&&c.get(0)&&a.data(c.get(0),"tokeninput")?A(c):(o&&z(a(o),d.END),m.focus())}).mouseover(function(b){var c=a(b.target).closest("li");c&&o!==this&&c.addClass(g.classes.highlightedToken)}).mouseout(function(b){var c=a(b.target).closest("li");c&&o!==this&&c.removeClass(g.classes.highlightedToken)}).insertBefore(n),r=a("<li />").addClass(g.classes.inputToken).appendTo(q).append(m),s=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide(),t=a("<tester/>").insertAfter(m).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:m.css("fontSize"),fontFamily:m.css("fontFamily"),fontWeight:m.css("fontWeight"),letterSpacing:m.css("letterSpacing"),whiteSpace:"nowrap"});n.val(""),li_data=g.prePopulate||n.data("pre"),li_data&&li_data.length&&a.each(li_data,function(a,b){w(b.id,b.name)})},a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b),d={},e=0,f=function(){d={},e=0};this.add=function(a,b){e>c.max_size&&f(),d[a]||(e+=1),d[a]=b},this.get=function(a){return d[a]}}})(jQuery)